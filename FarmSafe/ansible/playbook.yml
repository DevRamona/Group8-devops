---
- name: Configure Application Server
  hosts: all
  become: yes
  vars:
    # Default variables (can be overridden by --extra-vars)
    docker_registry: ""
    backend_image: ""
    frontend_image: ""
    aws_region: "us-east-1"
    jwt_secret: "changeme"

  tasks:
    # -------------------------------------------------------------------------
    # 1. System Preparation & Swap (Crucial for small instances like t3.small)
    # -------------------------------------------------------------------------
    - name: Check for existing swap file
      stat:
        path: /swapfile
      register: swap_file

    - name: Create swap file (2GB)
      command: dd if=/dev/zero of=/swapfile bs=128M count=16
      when: not swap_file.stat.exists

    - name: Set swap permissions
      file:
        path: /swapfile
        mode: '0600'
      when: not swap_file.stat.exists

    - name: Format swap file
      command: mkswap /swapfile
      when: not swap_file.stat.exists

    - name: Enable swap
      command: swapon /swapfile
      when: not swap_file.stat.exists

    # -------------------------------------------------------------------------
    # 2. Install Docker & Dependencies
    # -------------------------------------------------------------------------
    - name: Update all packages
      dnf:
        name: "*"
        state: latest
        update_cache: yes

    - name: Install Docker and Git
      dnf:
        name:
          - docker
          - git
        state: present

    - name: Start and enable Docker service
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add user to docker group
      user:
        name: "{{ ansible_user | default('ec2-user') }}"
        groups: docker
        append: yes

    # -------------------------------------------------------------------------
    # 3. Install Docker Compose (Standalone)
    # -------------------------------------------------------------------------
    - name: Install Docker Compose
      get_url:
        url: "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-{{ ansible_architecture }}"
        dest: /usr/local/bin/docker-compose
        mode: '0755'

    # -------------------------------------------------------------------------
    # 4. Application Deployment
    # -------------------------------------------------------------------------
    - name: Create application directory
      file:
        path: /opt/farmsafe
        state: directory
        owner: "{{ ansible_user | default('ec2-user') }}"
        group: "{{ ansible_user | default('ec2-user') }}"
        mode: '0755'

    - name: Log in to ECR
      when: docker_registry != "" and ecr_token is defined
      shell: |
        echo "{{ ecr_token }}" | docker login --username AWS --password-stdin {{ docker_registry }}
      no_log: true

    - name: Generate docker-compose.yml
      copy:
        dest: /opt/farmsafe/docker-compose.yml
        content: |
          services:
            mongodb:
              image: mongo:7.0
              container_name: farmsafe-mongodb
              restart: unless-stopped
              ports:
                - "27017:27017"
              environment:
                MONGO_INITDB_DATABASE: farmsafe_db
              volumes:
                - mongodb_data:/data/db
              healthcheck:
                test: ["CMD", "mongosh", "localhost:27017/farmsafe_db", "--quiet", "--eval", "db.runCommand({ ping: 1 }).ok"]
                interval: 10s
                timeout: 5s
                retries: 5

            backend:
              image: "{{ backend_image }}"
              container_name: farmsafe-backend
              restart: unless-stopped
              environment:
                NODE_ENV: production
                PORT: 5000
                MONGO_URI: mongodb://mongodb:27017/farmsafe_db
                JWT_SECRET: "{{ jwt_secret }}"
              ports:
                - "5000:5000"
              depends_on:
                mongodb:
                  condition: service_healthy
              healthcheck:
                test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/', r => process.exit(r.statusCode === 200 ? 0 : 1))"]
                interval: 30s
                timeout: 3s
                retries: 3
                start_period: 10s

            frontend:
              image: "{{ frontend_image }}"
              container_name: farmsafe-frontend
              restart: unless-stopped
              ports:
                - "80:80"
              depends_on:
                backend:
                  condition: service_healthy

          volumes:
            mongodb_data:
              driver: local

    - name: Pull Docker images
      command: docker-compose pull
      args:
        chdir: /opt/farmsafe
      when: backend_image != "" and frontend_image != ""

    - name: Start Application Stack
      command: docker-compose up -d
      args:
        chdir: /opt/farmsafe
      when: backend_image != "" and frontend_image != ""

    - name: Prune unused Docker images
      command: docker image prune -f
