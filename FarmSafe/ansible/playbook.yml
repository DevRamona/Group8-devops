---
- hosts: all
  become: yes
  vars:
    # These variables are passed in via --extra-vars
    docker_registry: "{{ docker_registry | default('') }}"
    docker_image: "{{ docker_image | default('') }}"
    aws_region: "{{ aws_region | default('us-east-1') }}"

  tasks:
    # --- System Setup Tasks ---

    # FIX for the "Unsupported parameters for (ansible.legacy.command) module: warn" error.
    # We use the explicit 'cmd' key within the 'shell' module to prevent Ansible 
    # from incorrectly falling back to the 'command' module.
    - name: Ensure DNF lock is removed (Force Shell Module)
      shell:
        cmd: |
          rm -f /var/cache/dnf/*/*.lock
          rm -f /var/run/dnf.pid
        warn: false # This argument is now correctly passed to the shell module
      failed_when: false # Allows this task to pass even if the files don't exist
      become: yes

    # Amazon Linux 2023 uses dnf as package manager
    - name: Update package index (dnf)
      dnf:
        update_cache: yes
      become: yes

    - name: Install required packages
      dnf:
        name:
          - python3-pip
          - docker
        state: present
      become: yes

    # --- Docker Login and Service Tasks ---

    - name: Ensure the Docker service is running and enabled
      systemd:
        name: docker
        state: started
        enabled: yes
      become: yes

    - name: Install Python required packages for Docker interaction
      pip:
        name:
          - docker
          - boto3
        executable: pip3
      become: yes

    - name: Log in to AWS ECR
      community.aws.ecr_login:
        region: "{{ aws_region }}"
      become: yes

    # --- Application Deployment Tasks ---
      
    - name: Pull the specific Docker image
      community.docker.docker_image:
        name: "{{ docker_image }}"
        source: pull
        state: present
        # Note: login is handled by ecr_login task

    - name: Stop and remove old container
      community.docker.docker_container:
        name: farmsafe_app
        state: absent
      ignore_errors: yes

    - name: Deploy the new Docker container (FarmSafe)
      community.docker.docker_container:
        name: farmsafe_app
        image: "{{ docker_image }}"
        state: started
        restart_policy: always
        ports:
          - "80:80" # Map host port 80 to container port 80
        env:
          # Pass environment variables to the container if needed
          AWS_REGION: "{{ aws_region }}"
          REGISTRY: "{{ docker_registry }}"
          # Add any other required environment variables here
      become: yes