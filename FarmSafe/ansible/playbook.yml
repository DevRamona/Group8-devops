---
- hosts: all
  become: yes
  vars:
    # These variables are passed in via --extra-vars
    docker_registry: "{{ docker_registry | default('') }}"
    docker_image: "{{ docker_image | default('') }}"
    aws_region: "{{ aws_region | default('us-east-1') }}"

  tasks:
    # --- System Setup Tasks ---

    # FIX for the "Unsupported parameters for (ansible.legacy.command) module: warn" error.
    # We use the explicit 'cmd' key within the 'shell' module to prevent Ansible 
    # from incorrectly falling back to the 'command' module.
    - name: Ensure DNF lock is removed (Force Shell Module)
      shell: |
        rm -f /var/cache/dnf/*/*.lock
        rm -f /var/run/dnf.pid
      failed_when: false # Allows this task to pass even if the files don't exist
      become: yes

    # Amazon Linux 2023 uses dnf as package manager
    - name: Wait for SSH connection to stabilize
      wait_for_connection:
        delay: 5
        timeout: 60

    - name: Update package index (dnf)
      dnf:
        update_cache: yes
      become: yes
      retries: 3
      delay: 10

    - name: Install required packages
      dnf:
        name:
          - python3-pip
          - docker
        state: present
      become: yes

    # --- Docker Login and Service Tasks ---

    - name: Ensure the Docker service is running and enabled
      systemd:
        name: docker
        state: started
        enabled: yes
      become: yes

    - name: Install Python required packages for Docker interaction
      pip:
        name:
          - docker
          - boto3
        executable: pip3
      become: yes

    - name: Log in to AWS ECR
      shell: |
        aws ecr get-login-password --region {{ aws_region }} | docker login --username AWS --password-stdin {{ docker_registry }}
      register: ecr_login
      changed_when: false
      become: yes

    # --- Application Deployment Tasks ---
      
    - name: Pull the specific Docker image
      shell: docker pull {{ docker_image }}
      become: yes

    - name: Stop and remove old container
      shell: docker rm -f farmsafe_app || true
      become: yes

    - name: Deploy the new Docker container (FarmSafe)
      shell: |
        docker run -d --name farmsafe_app --restart always -p 80:80 \
          -e AWS_REGION={{ aws_region }} \
          -e REGISTRY={{ docker_registry }} \
          {{ docker_image }}
      become: yes