---
- hosts: all
  become: yes
  tasks:
    - name: Check if Docker is installed
      command: docker --version
      register: docker_version
      failed_when: false

    - name: Display Docker version
      debug:
        msg: "Docker version: {{ docker_version.stdout }}"
      when: docker_version.rc == 0

    - name: Check if Docker service is running
      service:
        name: docker
        state: started
      register: docker_service
      failed_when: false

    - name: Display Docker service status
      debug:
        msg: "Docker service is {{ 'running' if docker_service.changed == false else 'started' }}"
      when: docker_service is not failed

    - name: Check if Docker Compose is installed
      command: docker-compose --version
      register: docker_compose_version
      failed_when: false

    - name: Display Docker Compose version
      debug:
        msg: "Docker Compose version: {{ docker_compose_version.stdout }}"
      when: docker_compose_version.rc == 0

    - name: Test Docker functionality by running hello-world
      command: docker run --rm hello-world
      register: docker_test
      failed_when: false

    - name: Display Docker test result
      debug:
        msg: "Docker test {{ 'passed' if docker_test.rc == 0 else 'failed' }}: {{ docker_test.stdout | default(docker_test.stderr) }}"
      when: docker_test is defined

    - name: Get current user
      command: whoami
      become: no
      register: current_user
      failed_when: false

    - name: Check if user can run Docker without sudo
      command: docker ps
      become: no
      register: docker_user_check
      failed_when: false

    - name: Display Docker user access status
      debug:
        msg: "Current user {{ current_user.stdout | default('unknown') }} {{ 'can' if docker_user_check.rc == 0 else 'cannot' }} run Docker commands without sudo"
      when: docker_user_check is defined