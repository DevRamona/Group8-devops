- hosts: all
  become: yes
  tasks:
    - name: Reset connection to apply group changes
      meta: reset_connection

    - name: Check if Docker is installed
      command: docker --version
      register: docker_version
      failed_when: false

    - name: Display Docker version
      debug:
        msg: "Docker version: {{ docker_version.stdout }}"
      when: docker_version.rc == 0

    - name: Check if Docker service is running
      service:
        name: docker
        state: started
      register: docker_service
      failed_when: false

    - name: Display Docker service status
      debug:
        msg: "Docker service is active and running"
      when: docker_service is not failed

    - name: Check if Docker Compose (Plugin) is installed
      shell: docker compose version
      register: docker_compose_version
      failed_when: false

    - name: Display Docker Compose version
      debug:
        msg: "Docker Compose version: {{ docker_compose_version.stdout }}"
      when: docker_compose_version.rc == 0

    - name: Test Docker functionality (as root)
      command: docker run --rm hello-world
      register: docker_test_root
      failed_when: false

    - name: Display Root Docker test result
      debug:
        msg: "Root Docker test: {{ 'PASSED' if docker_test_root.rc == 0 else 'FAILED' }}"

    - name: Get current user
      command: whoami
      become: no
      register: current_user
      changed_when: false

    - name: Check if user can run Docker without sudo
      command: docker ps
      become: no
      register: docker_user_check
      failed_when: false

    - name: Display Docker user access status
      debug:
        msg: "User '{{ current_user.stdout }}' {{ 'CAN' if docker_user_check.rc == 0 else 'CANNOT' }} run Docker commands without sudo."