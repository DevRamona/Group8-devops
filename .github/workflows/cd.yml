name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          # Only scan bastion host (public IP) - app host is private and unreachable directly
          ssh-keyscan -H ${{ secrets.ANSIBLE_BASTION_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
      - name: Verify SSH connection to bastion
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 ec2-user@${{ secrets.ANSIBLE_BASTION_HOST }} "echo 'Bastion connection successful'"

      - name: Deploy to EC2
        env:
          BASTION_IP: ${{ secrets.ANSIBLE_BASTION_HOST }}
          APP_PRIVATE_IP: ${{ secrets.ANSIBLE_APP_HOST }}
          SSH_KEY: ${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}
        run: |
          # Create SSH config for jump host
          cat > ~/.ssh/config << EOF
          Host bastion
            HostName ${BASTION_IP}
            User ec2-user
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no

          Host app
            HostName ${APP_PRIVATE_IP}
            User ec2-user
            IdentityFile ~/.ssh/deploy_key
            ProxyJump bastion
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

          # Deploy to app instance
          ssh app << 'DEPLOY_SCRIPT'
            set -e
            cd ~/Group8-devops/FarmSafe
            
            # Pull latest code
            echo "Pulling latest code..."
            git pull origin main
            
            # Rebuild and restart containers
            echo "Rebuilding containers..."
            docker compose down
            docker compose build --no-cache
            docker compose up -d
            
            # Wait for services to be healthy
            echo "Waiting for services to start..."
            sleep 10
            
            # Verify deployment
            echo "Verifying deployment..."
            docker compose ps
            
            # Check if services are responding
            if curl -f http://localhost:5000 > /dev/null 2>&1; then
              echo "Backend is responding"
            else
              echo "Backend health check failed"
            fi
            
            if curl -f http://localhost > /dev/null 2>&1; then
              echo "Frontend is responding"
            else
              echo "Frontend health check failed"
            fi
            
            echo "Deployment complete!"
          DEPLOY_SCRIPT

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Application deployed successfully to production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URL:** http://farmsafe-dev-alb-1865447178.us-east-1.elb.amazonaws.com/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

