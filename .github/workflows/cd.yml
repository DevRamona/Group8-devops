name: Deploy to Production

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

env:
  NODE_VERSION: 20
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY || 'farmsafe-dev' }}
  APP_DOCKER_CONTEXT: FarmSafe
  DOCKERFILE_PATH: FarmSafe/Dockerfile
  FRONTEND_DOCKER_CONTEXT: FarmSafe/frontend
  FRONTEND_DOCKERFILE_PATH: FarmSafe/frontend/Dockerfile

jobs:
  backend_ci:
    name: Backend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: FarmSafe/backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: FarmSafe/backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Test
        run: npm test

  frontend_ci:
    name: Frontend CI
    runs-on: ubuntu-latest
    needs: backend_ci
    defaults:
      run:
        working-directory: FarmSafe/frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: FarmSafe/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Test
        run: npm test

  security_scans:
    name: Security Scans
    runs-on: ubuntu-latest
    needs:
      - backend_ci
      - frontend_ci
    steps:
      - uses: actions/checkout@v4

      - name: Run tfsec (IaC)
        uses: aquasecurity/tfsec-action@v1.0.1

      - name: Trivy file system scan
        uses: aquasecurity/trivy-action@0.11.0
        with:
          scan-type: fs
          format: table
          severity: CRITICAL
          exit-code: 1
          output: trivy-fs.txt

      - name: Build Docker image for scanning
        run: |
          docker build \
            -f $DOCKERFILE_PATH \
            -t farmsafe-sec-scan:${{ github.sha }} \
            $APP_DOCKER_CONTEXT

      - name: Trivy image scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: farmsafe-sec-scan:${{ github.sha }}
          format: table
          severity: CRITICAL
          exit-code: 1
          output: trivy-image.txt

  deploy:
    name: Build, Push, and Deploy
    runs-on: ubuntu-latest
    needs:
      - security_scans
    env:
      IMAGE_TAG: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push backend image
        id: build-backend
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          IMAGE_URI=$REGISTRY/${{ env.ECR_REPOSITORY }}:backend-${{ env.IMAGE_TAG }}
          LATEST_URI=$REGISTRY/${{ env.ECR_REPOSITORY }}:backend-latest

          docker build \
            -f $DOCKERFILE_PATH \
            -t $IMAGE_URI \
            $APP_DOCKER_CONTEXT

          docker tag $IMAGE_URI $LATEST_URI
          docker push $IMAGE_URI
          docker push $LATEST_URI

          echo "image_uri=$IMAGE_URI" >> "$GITHUB_OUTPUT"

      - name: Build and push frontend image
        id: build-frontend
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          IMAGE_URI=$REGISTRY/${{ env.ECR_REPOSITORY }}:frontend-${{ env.IMAGE_TAG }}
          LATEST_URI=$REGISTRY/${{ env.ECR_REPOSITORY }}:frontend-latest

          docker build \
            -f $FRONTEND_DOCKERFILE_PATH \
            -t $IMAGE_URI \
            $FRONTEND_DOCKER_CONTEXT

          docker tag $IMAGE_URI $LATEST_URI
          docker push $IMAGE_URI
          docker push $LATEST_URI

          echo "image_uri=$IMAGE_URI" >> "$GITHUB_OUTPUT"

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          python3 -m pip install --upgrade pip
          pip install ansible
          ansible-galaxy collection install community.aws
          ansible-galaxy collection install community.docker

      - name: Install Ansible Collections (Fix for ECR Login)
        run: |
          ansible-galaxy collection install community.aws

      - name: Get bastion host IP
        id: bastion-ip-for-ssh
        run: |
          BASTION_IP=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Name,Values=farmsafe-dev-bastion" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "bastion_ip=$BASTION_IP" >> "$GITHUB_OUTPUT"
          echo "Bastion host IP: $BASTION_IP"

      - name: Get app instance private IP
        id: app-private-ip-for-ssh
        run: |
          APP_IP=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Name,Values=farmsafe-dev-app" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PrivateIpAddress' \
            --output text)
          echo "app_private_ip=$APP_IP" >> "$GITHUB_OUTPUT"
          echo "App instance private IP: $APP_IP"

      - name: Verify IPs are retrieved
        run: |
          if [ -z "${{ steps.bastion-ip-for-ssh.outputs.bastion_ip }}" ]; then
            echo "Error: Bastion IP is empty"
            exit 1
          fi
          if [ -z "${{ steps.app-private-ip-for-ssh.outputs.app_private_ip }}" ]; then
            echo "Error: App private IP is empty"
            exit 1
          fi
          echo "Bastion IP: ${{ steps.bastion-ip-for-ssh.outputs.bastion_ip }}"
          echo "App private IP: ${{ steps.app-private-ip-for-ssh.outputs.app_private_ip }}"

      - name: Prepare SSH key and config
        run: |
          mkdir -p ~/.ssh
          SSH_CONFIG_PATH="$HOME/.ssh/config"
          SSH_KEY_PATH="$HOME/.ssh/id_rsa"
          
          echo "${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}" > "$SSH_KEY_PATH"
          chmod 600 "$SSH_KEY_PATH"
          
          # Create SSH config for jump host (bastion)
          cat > "$SSH_CONFIG_PATH" << EOF
          Host bastion
            HostName ${{ steps.bastion-ip-for-ssh.outputs.bastion_ip }}
            User ${{ secrets.ANSIBLE_USER }}
            IdentityFile $SSH_KEY_PATH
            StrictHostKeyChecking no
            ServerAliveInterval 60
            ServerAliveCountMax 3
            TCPKeepAlive yes
            ConnectTimeout 30
        
          Host app
            HostName ${{ steps.app-private-ip-for-ssh.outputs.app_private_ip }}
            User ${{ secrets.ANSIBLE_USER }}
            IdentityFile $SSH_KEY_PATH
            ProxyJump bastion
            StrictHostKeyChecking no
            ServerAliveInterval 60
            ServerAliveCountMax 3
            TCPKeepAlive yes
            ConnectTimeout 30
          EOF
          chmod 600 "$SSH_CONFIG_PATH"
          
          # Create Ansible inventory with absolute paths and keepalive settings
          echo "app ansible_host=app ansible_user=${{ secrets.ANSIBLE_USER }} ansible_ssh_private_key_file=$SSH_KEY_PATH ansible_ssh_common_args='-o StrictHostKeyChecking=no -o ControlMaster=no -o ControlPersist=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o TCPKeepAlive=yes -o ConnectTimeout=30 -F $SSH_CONFIG_PATH' ansible_ssh_pipelining=True" > inventory.ini
          
          # Verify SSH config exists
          echo "SSH config path: $SSH_CONFIG_PATH"
          ls -la "$SSH_CONFIG_PATH" || echo "SSH config file not found!"

      - name: Test SSH connection to bastion
        run: |
          SSH_CONFIG_PATH="$HOME/.ssh/config"
          SSH_KEY_PATH="$HOME/.ssh/id_rsa"
          echo "Testing SSH to bastion..."
          ssh -i "$SSH_KEY_PATH" -F "$SSH_CONFIG_PATH" -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.ANSIBLE_USER }}@bastion "echo 'SSH to bastion successful'" || (echo "SSH to bastion failed"; exit 1)

      - name: Test SSH connection to app via bastion
        run: |
          SSH_CONFIG_PATH="$HOME/.ssh/config"
          SSH_KEY_PATH="$HOME/.ssh/id_rsa"
          echo "Testing SSH to app via bastion..."
          ssh -i "$SSH_KEY_PATH" -F "$SSH_CONFIG_PATH" -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.ANSIBLE_USER }}@app "echo 'SSH to app successful'" || (echo "SSH to app failed"; exit 1)

      - name: Debug inventory
        run: |
          echo "===== inventory.ini contents ====="
          cat inventory.ini
          echo "================================="

      - name: Wait for instances to be ready
        run: sleep 60

      - name: Run Ansible playbook
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          ansible-playbook \
            -vvv \
            -i inventory.ini \
            --extra-vars "docker_registry=$REGISTRY docker_image=${{ steps.build-and-push.outputs.image_uri }} aws_region=${{ env.AWS_REGION }}" \
            FarmSafe/ansible/playbook.yml


      - name: Prepare bastion inventory
        run: |
          SSH_CONFIG_PATH="$HOME/.ssh/config"
          SSH_KEY_PATH="$HOME/.ssh/id_rsa"
          echo "bastion ansible_host=bastion ansible_user=${{ secrets.ANSIBLE_USER }} ansible_ssh_private_key_file=$SSH_KEY_PATH ansible_ssh_common_args='-o StrictHostKeyChecking=no -F $SSH_CONFIG_PATH'" > bastion-inventory.ini

      - name: Configure nginx on bastion
        if: steps.app-ip.outputs.app_private_ip != ''
        run: |
          ansible-playbook \
            -i bastion-inventory.ini \
            --extra-vars "app_private_ip=${{ steps.app-private-ip-for-ssh.outputs.app_private_ip }}" \
            FarmSafe/ansible/bastion-playbook.yml

      - name: Display application URL
        run: |
          echo "::notice::Application is accessible at: http://${{ steps.bastion-ip-for-ssh.outputs.bastion_ip }}"


