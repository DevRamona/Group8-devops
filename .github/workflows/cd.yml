name: Deploy to Production

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

env:
  NODE_VERSION: 20
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY || 'farmsafe-dev' }}
  APP_DOCKER_CONTEXT: FarmSafe
  DOCKERFILE_PATH: FarmSafe/Dockerfile

jobs:
  backend_ci:
    name: Backend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: FarmSafe/backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: FarmSafe/backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Test
        run: npm test

  frontend_ci:
    name: Frontend CI
    runs-on: ubuntu-latest
    needs: backend_ci
    defaults:
      run:
        working-directory: FarmSafe/frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: FarmSafe/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Test
        run: npm test

  security_scans:
    name: Security Scans
    runs-on: ubuntu-latest
    needs:
      - backend_ci
      - frontend_ci
    steps:
      - uses: actions/checkout@v4

      - name: Run tfsec (IaC)
        uses: aquasecurity/tfsec-action@v1.0.1

      - name: Trivy file system scan
        uses: aquasecurity/trivy-action@0.11.0
        with:
          scan-type: fs
          format: table
          severity: CRITICAL
          exit-code: 1
          output: trivy-fs.txt

      - name: Build Docker image for scanning
        run: |
          docker build \
            -f $DOCKERFILE_PATH \
            -t farmsafe-sec-scan:${{ github.sha }} \
            $APP_DOCKER_CONTEXT

      - name: Trivy image scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: farmsafe-sec-scan:${{ github.sha }}
          format: table
          severity: CRITICAL
          exit-code: 1
          output: trivy-image.txt

  deploy:
    name: Build, Push, and Deploy
    runs-on: ubuntu-latest
    needs:
      - security_scans
    env:
      IMAGE_TAG: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        id: build-and-push
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          IMAGE_URI=$REGISTRY/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          LATEST_URI=$REGISTRY/${{ env.ECR_REPOSITORY }}:latest

          docker build \
            -f $DOCKERFILE_PATH \
            -t $IMAGE_URI \
            $APP_DOCKER_CONTEXT

          docker tag $IMAGE_URI $LATEST_URI
          docker push $IMAGE_URI
          docker push $LATEST_URI

          echo "image_uri=$IMAGE_URI" >> "$GITHUB_OUTPUT"

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          python3 -m pip install --upgrade pip
          pip install ansible

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "app ansible_host=${{ secrets.ANSIBLE_HOST }} ansible_user=${{ secrets.ANSIBLE_USER }} ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'" > inventory.ini

      - name: Debug inventory
        run: |
          echo "===== inventory.ini contents ====="
          cat inventory.ini
          echo "================================="

      - name: Get ECR login token
        id: ecr-token
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          ECR_TOKEN=$(aws ecr get-login-password --region ${{ env.AWS_REGION }})
          echo "token=$ECR_TOKEN" >> "$GITHUB_OUTPUT"
          echo "registry=$REGISTRY" >> "$GITHUB_OUTPUT"

      - name: Run Ansible playbook for app instance
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          ansible-playbook \
            -i inventory.ini \
            --extra-vars "docker_registry=$REGISTRY docker_image=${{ steps.build-and-push.outputs.image_uri }} aws_region=${{ env.AWS_REGION }} ecr_token=${{ steps.ecr-token.outputs.token }}" \
            FarmSafe/ansible/playbook.yml

      - name: Get app instance private IP
        id: app-ip
        run: |
          APP_IP=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Name,Values=farmsafe-dev-app" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PrivateIpAddress' \
            --output text)
          echo "app_private_ip=$APP_IP" >> "$GITHUB_OUTPUT"
          echo "App instance private IP: $APP_IP"

      - name: Get bastion host IP
        id: bastion-ip
        run: |
          BASTION_IP=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Name,Values=farmsafe-dev-bastion" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "bastion_ip=$BASTION_IP" >> "$GITHUB_OUTPUT"
          echo "Bastion host IP: $BASTION_IP"

      - name: Prepare bastion inventory
        run: |
          echo "bastion ansible_host=${{ steps.bastion-ip.outputs.bastion_ip }} ansible_user=${{ secrets.ANSIBLE_USER }} ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'" > bastion-inventory.ini

      - name: Configure nginx on bastion
        if: steps.app-ip.outputs.app_private_ip != ''
        run: |
          ansible-playbook \
            -i bastion-inventory.ini \
            --extra-vars "app_private_ip=${{ steps.app-ip.outputs.app_private_ip }}" \
            FarmSafe/ansible/bastion-playbook.yml

      - name: Display application URL
        run: |
          echo "::notice::Application is accessible at: http://${{ steps.bastion-ip.outputs.bastion_ip }}"


